# OAuth 2.0 카카오 로그인
> 어플리케이션 간의 인증과 허가를 위해서 사용하는 프로토콜
> 사용자의 신상을 노출하지 않고 다른 제 3자의 인증을 받아서 
> 사용자의 정보를 동의를 받고 정보를 기반으로 권한을 인증할수 있게 한다.
> https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api

## OAuth는 인증과 허가를 제공하는 프로토콜
> 목적은 사용자가 자신의 아이디와 비밀번호를 외부에 노출하지 않고
> 외부의 서비스에 본인의 아이디나 비밀번호를 제공하지 않고 제 3자를 통해서 다른 서비스를 사용할수 있는 기능을 제공
> 사용자가 플랫폼의 로그인 없이 제 3자 즉 카카오 구글 네이버 등의 로그인을 통해서 서비스를 이용할 수 있게 한다.

1. oauth 1.0 : 이전에는 서명의 값으로 안전성은 높지만 방식이 어렵고 복잡했다. 보안강화를 서명방식으로 강화를 했다.
                클라이언트와 서버간의 요청은 서명된 형태로 전송을 했었고  안전한 방식이었지만 구현이 복잡하고 함들다는 단점이 있었음

2. oauth 2.0 :  1.0의 복잡한 서명의 방식을 개선해서 인증방식을 다르게 제공하게 되었다. 토큰의 인증을 사용해서 보안을 강화하고 , 서버는 엑세스 토큰을 발급해서 클라이언크는 받은 토큰을 가지고 권한을 증명할수있게 되었다. 확장성이 늘어난 것. JWT 토큰을 생성하여 인증 방식을 확장성 있고 안전한 방식으로 제공하게 되었다.

## 카카오 로그인 로직
> 카카오 로그인은 현재 2.0 프로토콜 사용해서 인증을 처리하고 있고, 사용자 인증을 API를 제공하고있고, api를 활용해서 카카오 계정으로 로그인하고 동의를 받은 후 인가코드를 전달받아서 코드를 가지고 정보를 요청해서 사용자 인증을 처리한다.

1. 사용자의 인증 : 유저가 어플리케이션에서 카카오 로그인을 클릭하게되면 리다이렉트로 카카오 서버의 로그인 화면으로 이동. 카카오 서버에서 제공받은 로그인 화면에서 로긍니을 하고 동의 화면까지 처리하게 되면 authorization code 인가 코드를 받아서 백엔드에게 전달 콜백 url 즉 리다이렉트 하는데 쿼리 스트링으로 인가코드를 전달.
> 카카오 서버에 로그인 요청을 보낼때에도 get 방식으로 리다이렉트를 하는데, 쿼리 스트링으로 포함시켜서 요청을 보낸다.

1.1. 쿼리스트링으로 담아주는 내용
- 인증코드의 형태를 요청하는 구문 : response_type = code
- 클라이언트의 아이디 즉 우리가 만든 서비스 어플리케이션의 아이디값 고유의 값: client_id
- 리다이렉트 될 백엔드의 경로. 로그인 이후 요청보낼 백엔드 경로 즉 인가 코드가 있는 상태 : redirect_url
- 동의에 필요한 내용을 담을 권한의 목록 : scope

2. 인가 코드 : 유저가 로그인하고 동의화면에서 동의까지 하면 카카오에서 발급해주는 인증 코드를 우리의 백엔드 경로로 리다이렉트 요청을 보내서 처리한다. 이 코드는 인증을 받았다는 의미, 유저가 동의한 내용의 API를 사용해서 유저의 정보 또는 메세지 전송 등 친구목록 등의 API를 호출할 수 있다. 

3. 액세스 토큰 : 인가코드까지 받고 하면 로그인 요청을 보낸 뒤 액세스 토큰 즉 카카오 로그인을 한 유저가 얼마나 인증권한을 유지할지
3.1 요청에 필요한 값
- grant_type=authorization_code
- code : 인가코드
- redirect_url : 재요청 보낼 백엔드의 주소
- client_id : 어플리케이션의 고유 아이디값
- client_secret : 어플리케이션의 비밀키(카카오 디벨로퍼 개발자 사이트에서 제공받는다)
> 액세스 토큰과 리프레시 토큰이 생성된다. 

4. api 유저 정보 요청
> 유저의 정보를 요청할 수 있는 권한이 생기고, 엑세스 토큰값을 가지고 인증 권한을 동의한 목록의 API를 호출할 수 있다. 요청보낼 수 있다.
> https://kapi.kakao.com/v2/user/me 이런 API에 요청을 할 때 엑세스 토큰을 헤더에 포함시켜서 요청을 보내줘야한다.
> 헤더에 {Authorization : Bearer 토큰 값 } Authorization 인증 토큰이라는 내용의 헤더값이고,  Bearer는 통상적으로 인증 토큰값이라고 알려주는 것. 토큰 검증을 하고 API의 응답을 해준다.

### 카카오 어플리케이션 생성
1. 개발자 사이트 접속 : https://developers.kakao.com/
2. 어플리케이션 탭에서 어플리케이션 생성한다.
3. 앱키의 사용할 키 목록을 확인해서 필요한 값을 가져온다. << restapi : 클라이언트 id>>
4. 제품설정에 카카오 로그인탭 > 활성화 설정, OpenID Connect 활성화, redireck url 등록
- redireck url : 로그인 후에 동의화면 이후 인가코드 받고 요청할 우리 백엔드 경로
5. 제품설정 탭에 동의항목 설정 API 요청을 보낼때 권한을 인증받은 서비스만 요청을 처리할 수 있다. 필요한 내용들을 모두 동의항목으로 추가.
6. 제품설정탭의 보안탭에서 시크릿키 코드 생성 : 토큰의 값을 더 안전하게 암호화 하기 위해서 사용되는 값이다. 
7. 제품설정탬의 고급탭에서 Logout Redirect URI추가 : 로그아웃 요청 이후 처리할 백엔드 경로 지정. 엑세스토큰과 리프레시토큰이 만료되는 요청을 logout api로 제공한다.


### 어플리케이션 설정 이후 
> 페이지에서 카카오 로그인 요청.

```sh
npm i express ejs jsonwebtoken cookie-parser axios dotenv
```
> 개발자 가이드
https://developers.kakao.com/docs/latest/ko/kakaologin/rest-api#req-user-info
